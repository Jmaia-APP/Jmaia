<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>رفع البطاقة الشخصية</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind -->
  <!-- <script src="https://cdn.tailwindcss.com"></script> -->
  <link rel="stylesheet" href="dist/tailwind.css">
  <style>
    .custom-green { background-color: #a7d4ca !important; color: #22675a !important; }
    .custom-green-text { color: #22675a !important; }
    .custom-green-bg { background-color: #a7d4ca !important; }
    .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-left: 6px; }
    .dot-red { background: #FF6B35; }
    .dot-green { background: #2DAA9E; }
    .border-dashed { border-style: dashed; }
  </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen font-sans">
  <div class="w-full max-w-sm mx-auto">
    <!-- الخطوة 1: التعليمات -->
    <div id="step1" class="bg-white shadow-lg rounded-xl p-5">
      <!-- العنوان -->
      <div class="flex items-center mb-4">
        <svg class="w-4 h-4 text-gray-800 ml-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
        </svg>
        <span class="text-base font-bold text-gray-800">إرفع البطاقة الشخصية</span>
      </div>
      <!-- التعليمات -->
      <div class="text-right text-gray-800 text-sm leading-loose mb-4 space-y-2">
        <div>وانت بتصور بطاقتك الشخصية، اتأكد إن وش وصورة البطاقة يكون:</div>
        <ul class="pr-6 mt-1 space-y-2">
          <li class="text-xs text-gray-800 flex items-center">
            <span class="dot dot-red"></span>
            في إضاءة كويسة
          </li>
          <li class="text-xs text-gray-800 flex items-center">
            <span class="dot dot-red"></span>
            جوا مربع التصوير (مش مقصوصة)
          </li>
        </ul>
      </div>
      <!-- صور البطاقات -->
      <div class="flex justify-between mt-4 mb-4 space-x-2 space-x-reverse">
        <!-- بطاقة 1 -->
        <div class="flex flex-col items-center w-1/2">
          <div class="custom-green rounded-full px-4 py-1 mb-2 -mt-4 text-xs font-bold shadow text-center">مرفوضة</div>
          <div class="border-2 border-gray-300 rounded-lg flex items-center justify-center w-24 h-20 bg-white">
            <svg width="40" height="32" viewBox="0 0 40 32" fill="none">
              <rect x="2" y="4" width="36" height="24" rx="3" fill="#fff" stroke="#222" stroke-width="2"/>
              <circle cx="10" cy="16" r="4" fill="#FF6B35"/>
              <rect x="18" y="12" width="14" height="2" rx="1" fill="#222"/>
              <rect x="18" y="18" width="10" height="2" rx="1" fill="#222"/>
            </svg>
          </div>
        </div>
        <!-- بطاقة 2 -->
        <div class="flex flex-col items-center w-1/2">
          <div class="custom-green rounded-full px-4 py-1 mb-2 -mt-4 text-xs font-bold shadow text-center">مرفوضة</div>
          <div class="border-2 border-gray-300 rounded-lg flex items-center justify-center w-24 h-20 bg-white">
            <svg width="40" height="32" viewBox="0 0 40 32" fill="none">
              <rect x="2" y="4" width="36" height="24" rx="3" fill="#fff" stroke="#222" stroke-width="2"/>
              <rect x="8" y="10" width="24" height="2" rx="1" fill="#222"/>
              <rect x="8" y="16" width="24" height="2" rx="1" fill="#222"/>
              <rect x="8" y="22" width="14" height="2" rx="1" fill="#222"/>
              <circle cx="30" cy="23" r="3" fill="#fff" stroke="#222" stroke-width="1.5"/>
            </svg>
          </div>
        </div>
      </div>
      <!-- ملاحظة البنك -->
      <div class="custom-green-bg rounded-lg p-3 mt-4 mb-4 text-xs text-right custom-green-text leading-relaxed flex items-start">
        <svg class="w-5 h-5 ml-2 mt-1 custom-green-text flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2a4 4 0 014-4h3m0 0V7a4 4 0 00-8 0v4m8 0a4 4 0 01-8 0"/>
        </svg>
        <span>
          طبقاً لتعليمات بنك المركزي السعودي كل مستخدم مطالب يرفع صورة لبطاقته الشخصية (سارية) لتأكيد بياناته للإشتراك في الجمعية وده لضمان حقوق كل المشتركين.
        </span>
      </div>
      <!-- زر الرفع -->
      <button id="startBtn" class="w-full border border-green-400 rounded-full py-2 text-green-900 font-medium text-base hover:bg-green-50 transition mt-2 focus:outline-none">إرفع البطاقة الشخصية</button>
    </div>

    <!-- الخطوة 2: قبل البدء -->
    <div id="step2" class="bg-white shadow-lg rounded-xl p-5 hidden">
      <div class="flex justify-between items-center mb-4">
        <span></span>
        <svg id="closeStep2" class="w-6 h-6 text-green-700 cursor-pointer" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 6l12 12M6 18L18 6"/>
        </svg>
      </div>
      <div class="text-center">
        <div class="text-2xl font-bold text-green-700 mb-2">قبل البدء :</div>
        <svg class="mx-auto my-4" width="80" height="80" viewBox="0 0 24 24" fill="none">
          <path d="M12 21c4.97 0 9-4.03 9-9s-4.03-9-9-9-9 4.03-9 9 4.03 9 9 9zm0-16a7 7 0 110 14 7 7 0 010-14zm1 3h-2v5h2V8zm0 6h-2v2h2v-2z" fill="#2DAA9E"/>
          <path d="M9 12h6" stroke="#2DAA9E" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <div class="text-gray-700 text-sm mb-4">احرص على حمل البطاقة في يدك وعدم وضعها على أي سطح.</div>
        <!-- اختيار الكاميرا -->
        <div class="mb-4">
          <label for="cameraSelect" class="block mb-1 text-sm text-gray-700">اختر الكاميرا:</label>
          <select id="cameraSelect" class="w-full border rounded px-2 py-1 text-sm">
            <option value="environment">الخلفية</option>
            <option value="user">الأمامية</option>
          </select>
        </div>
        <button id="beginCapture" class="w-full border border-green-400 rounded-full py-2 text-green-900 font-medium text-base hover:bg-green-50 transition">ابدأ</button>
      </div>
    </div>

    <!-- الخطوة 3: التقاط الصور وعرضها -->
    <div id="step3" class="bg-white shadow-lg rounded-xl p-5 hidden">
      <div class="flex justify-between items-center mb-4">
        <span></span>
        <svg id="closeStep3" class="w-6 h-6 text-green-700 cursor-pointer" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 6l12 12M6 18L18 6"/>
        </svg>
      </div>
      <div id="captureArea">
        <div class="text-center mb-4">
          <div id="captureMsg" class="text-green-900 font-bold text-base mb-2">التقط صورة وجه البطاقة</div>
          <video id="video" autoplay playsinline class="mx-auto rounded-lg border-2 border-dashed border-green-400 w-full max-w-xs h-48 object-cover"></video>
          <button id="captureBtn" class="w-full border border-green-400 rounded-full py-2 text-green-900 font-medium text-base hover:bg-green-50 transition mt-3">التقط الصورة</button>
        </div>
      </div>
      <div id="resultArea" class="hidden">
        <div class="flex flex-col gap-4 mb-4">
          <img id="frontImg" class="rounded-lg border border-gray-300 w-full max-w-xs mx-auto" src="" alt="وجه البطاقة">
          <img id="backImg" class="rounded-lg border border-gray-300 w-full max-w-xs mx-auto" src="" alt="خلف البطاقة">
        </div>
        <button id="doneBtn" class="w-full border border-green-400 rounded-full py-2 text-green-900 font-medium text-base hover:bg-green-50 transition">تم</button>
      </div>
    </div>
  </div>
  <script>
    // عناصر الخطوات
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const startBtn = document.getElementById('startBtn');
    const beginCapture = document.getElementById('beginCapture');
    const closeStep2 = document.getElementById('closeStep2');
    const closeStep3 = document.getElementById('closeStep3');

    // التقاط الصور
    let videoStream = null;
    let frontImageUrl = null;
    let backImageUrl = null;
    let captureStep = 0; // 0: front, 1: back

    // زر "إرفع البطاقة الشخصية"
    startBtn.onclick = function() {
      step1.classList.add('hidden');
      step2.classList.remove('hidden');
    };

    // زر إغلاق "قبل البدء"
    closeStep2.onclick = function() {
      step2.classList.add('hidden');
      step1.classList.remove('hidden');
    };

    // زر "ابدأ"
    beginCapture.onclick = async function() {
      step2.classList.add('hidden');
      step3.classList.remove('hidden');
      await startCamera();
      showCaptureStep(0);
    };

    // زر إغلاق التقاط الصور
    closeStep3.onclick = function() {
      step3.classList.add('hidden');
      step1.classList.remove('hidden');
      stopCamera();
      resetCapture();
    };

    // الكاميرا
    const video = document.getElementById('video');
    const captureBtn = document.getElementById('captureBtn');
    const captureMsg = document.getElementById('captureMsg');
    const captureArea = document.getElementById('captureArea');
    const resultArea = document.getElementById('resultArea');
    const frontImg = document.getElementById('frontImg');
    const backImg = document.getElementById('backImg');

    async function startCamera() {
      if (videoStream) return;
      const cameraSelect = document.getElementById('cameraSelect');
      const facingMode = cameraSelect ? cameraSelect.value : "environment";
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: facingMode } },
          audio: false
        });
        video.srcObject = videoStream;
      } catch (e) {
        alert('تعذر الوصول للكاميرا');
      }
    }

    function stopCamera() {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
      video.srcObject = null;
    }

    // مؤشر تحميل
    function showLoading(msg = 'جاري رفع الصورة...') {
      captureMsg.textContent = msg;
      captureBtn.disabled = true;
      captureBtn.textContent = '...جاري الرفع';
    }
    function hideLoading() {
      captureBtn.disabled = false;
      captureBtn.textContent = 'التقط الصورة';
    }

    // Helper: Convert dataURL to File
    function dataURLtoFile(dataurl, filename) {
      const arr = dataurl.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
      }
      return new File([u8arr], filename, { type: mime });
    }

    // رفع الصورة إلى السيرفر
    async function uploadImage(dataUrl) {
      let file;
      const fallbackUrl = 'https://abdelrhmanaymanfathi.github.io/Deployment-Gamaia/Assets/imgs/anynoums.jpg';
      if (!dataUrl) {
        // استخدم صورة عامة إذا لم تتوفر صورة
        const response = await fetch(fallbackUrl);
        const blob = await response.blob();
        file = new File([blob], 'national_id.jpg', { type: blob.type || 'image/jpeg' });
      } else {
        try {
          file = dataURLtoFile(dataUrl, 'national_id.png');
        } catch (e) {
          // إذا فشل التحويل، استخدم صورة مجهولة
          const response = await fetch(fallbackUrl);
          const blob = await response.blob();
          file = new File([blob], 'national_id.jpg', { type: blob.type || 'image/jpeg' });
        }
      }
      const formData = new FormData();
      formData.append('nationalIdImage', file, file.name);
      const res = await fetch('https://api.technologytanda.com/api/nationalID/upload', {
        method: 'POST',
        body: formData
      });
      if (!res.ok) throw new Error('فشل رفع الصورة');
      const json = await res.json();
      // ارجع رابط الصورة الكامل
      return 'https://api.technologytanda.com/api/nationalID/' + json.filePath.split('/').pop();
    }

    function resetCapture() {
      captureStep = 0;
      frontImageUrl = null;
      backImageUrl = null;
      captureArea.classList.remove('hidden');
      resultArea.classList.add('hidden');
    }

    function showCaptureStep(step) {
      captureStep = step;
      captureArea.classList.remove('hidden');
      resultArea.classList.add('hidden');
      if (step === 0) {
        captureMsg.textContent = 'التقط صورة وجه البطاقة';
      } else {
        captureMsg.textContent = 'التقط صورة خلف البطاقة';
      }
    }

    captureBtn.onclick = async function() {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imgData = canvas.toDataURL('image/png');
      showLoading();
      try {
        if (captureStep === 0) {
          frontImageUrl = await uploadImage(imgData);
          hideLoading();
          showCaptureStep(1);
        } else {
          backImageUrl = await uploadImage(imgData);
          hideLoading();
          stopCamera();
          showResult();
        }
      } catch (e) {
        hideLoading();
        alert('حدث خطأ أثناء رفع الصورة. حاول مرة أخرى.');
      }
    };

    function showResult() {
      frontImg.src = frontImageUrl || '';
      backImg.src = backImageUrl || '';
      captureArea.classList.add('hidden');
      resultArea.classList.remove('hidden');
    }

    // زر "تم" بعد رفع الصور
    document.getElementById('doneBtn').onclick = function() {
      window.location.href = 'assembly_contract.html';
    };
  </script>
</body>
</html>
