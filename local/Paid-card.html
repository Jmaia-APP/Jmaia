<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>تحميل بطاقة الرقم القومي</title>
  <!-- Tailwind -->
  <link rel="stylesheet" href="dist/tailwind.css">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body class="bg-gray-50 p-4 font-tajawal">

  <div id="nationalIDSection" class="max-w-md mx-auto bg-white p-6 rounded-xl shadow-lg">
    <!-- المحتوى الديناميكي سيُضاف هنا -->
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const section = document.getElementById('nationalIDSection');
    const API_BASE = 'http://localhost:3000';

    // دالة لإظهار واجهة رفع الصورة بشكل مشابه لـ National_id.html
    function showUploadForm(latestFront, latestBack) {
      section.innerHTML = `
        <div class="space-y-4">
          <div class="flex items-center mb-2">
            <button id="backBtn" class="mr-2 p-2 rounded-full   transition">
              <svg class="w-5 h-5  text-gray-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="rotate: 180deg;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
              </svg>
            </button>
            <span class="text-lg font-bold text-gray-800">إرفع الهوية الشخصية</span>
          </div>
          <div class="rounded-xl shadow-md border border-gray-200 bg-white p-4">
            <div class="text-right text-gray-800 text-sm leading-loose mb-2">
              <div>وانت بتصور هويتك الشخصية، اتأكد إن وش وصورة الهوية يكون:</div>
              <ul class="pr-6 mt-1 space-y-2">
                <li class="text-xs text-gray-800 flex items-center">
                  <span class="dot dot-red" style="background:#FF6B35;width:8px;height:8px;border-radius:50%;display:inline-block;margin-left:6px;"></span>
                  في إضاءة كويسة
                </li>
                <li class="text-xs text-gray-800 flex items-center">
                  <span class="dot dot-red" style="background:#FF6B35;width:8px;height:8px;border-radius:50%;display:inline-block;margin-left:6px;"></span>
                  جوا مربع التصوير (مش مقصوصة)
                </li>
              </ul>
            </div>
            <div class="flex justify-between gap-2 mb-2">
              <div class="flex-1 flex flex-col items-center">
                <div class="text-xs text-gray-500 mb-1">آخر وجه</div>
                <img src="${latestFront || 'https://raw.githubusercontent.com/Jmaia-APP/Jmaia/main/Assets/imgs/anynoums.jpg'}" alt="وجه البطاقة" class="rounded-xl border w-full h-24 object-cover shadow-sm"/>
              </div>
              <div class="flex-1 flex flex-col items-center">
                <div class="text-xs text-gray-500 mb-1">آخر خلف</div>
                <img src="${latestBack || 'https://raw.githubusercontent.com/Jmaia-APP/Jmaia/main/Assets/imgs/anynoums.jpg'}" alt="خلف البطاقة" class="rounded-xl border w-full h-24 object-cover shadow-sm"/>
              </div>
            </div>
            <div class="custom-green-bg rounded-lg p-3 text-xs text-right custom-green-text leading-relaxed flex items-start mb-4" style="background:#a7d4ca;color:#22675a;">
              <svg class="w-5 h-5 ml-2 mt-1 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2a4 4 0 014-4h3m0 0V7a4 4 0 00-8 0v4m8 0a4 4 0 01-8 0"/>
              </svg>
              <span>
                طبقاً لتعليمات بنك المركزي السعودي كل مستخدم مطالب يرفع صورة لبطاقته الشخصية (سارية) لتأكيد بياناته للإشتراك في الجمعية وده لضمان حقوق كل المشتركين.
              </span>
            </div>
            <div class="mb-2">
              <label class="block mb-1 text-sm text-gray-700">وجه البطاقة:</label>
              <div class="flex gap-2">
                <input type="file" id="frontInput" accept="image/*" class="block w-full border rounded-lg px-2 py-1 text-sm bg-gray-50 focus:ring-2 focus:ring-teal-200"/>
                <button id="frontCameraBtn" type="button" class="border border-green-400 rounded-lg px-2 py-1 text-xs text-green-900 bg-white hover:bg-green-50 transition">التقاط بالكاميرا</button>
              </div>
              <div id="frontCameraArea" class="hidden mt-2">
                <div class="flex items-center gap-2 mb-2">
                  <label class="text-xs">الكاميرا:</label>
                  <select id="frontFacingSelect" class="border rounded px-1 py-0.5 text-xs">
                    <option value="environment">خلفية</option>
                    <option value="user">أمامية</option>
                  </select>
                  <button id="frontCloseCamera" type="button" class="text-xs text-red-600 ml-auto">إغلاق</button>
                </div>
                <video id="frontVideo" autoplay playsinline class="rounded-lg border w-full h-32 object-cover mb-2 shadow"></video>
                <button id="frontCaptureBtn" type="button" class="w-full border border-green-400 rounded-lg py-1 text-green-900 text-xs bg-white hover:bg-green-50 transition">التقط الصورة</button>
              </div>
              <img id="frontPreview" class="rounded-lg border w-full h-24 object-cover mt-2 hidden shadow" alt="معاينة وجه البطاقة"/>
            </div>
            <div class="mb-4">
              <label class="block mb-1 text-sm text-gray-700">خلف البطاقة:</label>
              <div class="flex gap-2">
                <input type="file" id="backInput" accept="image/*" class="block w-full border rounded-lg px-2 py-1 text-sm bg-gray-50 focus:ring-2 focus:ring-teal-200"/>
                <button id="backCameraBtn" type="button" class="border border-green-400 rounded-lg px-2 py-1 text-xs text-green-900 bg-white hover:bg-green-50 transition">التقاط بالكاميرا</button>
              </div>
              <div id="backCameraArea" class="hidden mt-2">
                <div class="flex items-center gap-2 mb-2">
                  <label class="text-xs">الكاميرا:</label>
                  <select id="backFacingSelect" class="border rounded px-1 py-0.5 text-xs">
                    <option value="environment">خلفية</option>
                    <option value="user">أمامية</option>
                  </select>
                  <button id="backCloseCamera" type="button" class="text-xs text-red-600 ml-auto">إغلاق</button>
                </div>
                <video id="backVideo" autoplay playsinline class="rounded-lg border w-full h-32 object-cover mb-2 shadow"></video>
                <button id="backCaptureBtn" type="button" class="w-full border border-green-400 rounded-lg py-1 text-green-900 text-xs bg-white hover:bg-green-50 transition">التقط الصورة</button>
              </div>
              <img id="backPreview" class="rounded-lg border w-full h-24 object-cover mt-2 hidden shadow" alt="معاينة خلف البطاقة"/>
            </div>
            <button id="uploadBtn" class="w-full border border-green-400 rounded-full py-2 text-green-900 font-medium text-base hover:bg-green-50 transition mb-2">رفع الصور</button>
            <button id="confirmBtn" class="w-full border border-teal-500 rounded-full py-2 text-teal-700 font-bold text-base bg-teal-50 hover:bg-teal-100 transition flex items-center justify-center gap-2">
              <i class="bi bi-patch-check-fill text-teal-600 text-xl"></i>
              هويتك تمام ؟
            </button>
          </div>
        </div>
      `;

      // زر الرجوع
      document.getElementById('backBtn').onclick = () => window.history.back();

      // زر "هويتك تمام ؟"
      document.getElementById('confirmBtn').onclick = () => window.location.href = 'arrive.html';

      // --- الكاميرا لوجه البطاقة ---
      let frontStream = null;
      document.getElementById('frontCameraBtn').onclick = async function() {
        document.getElementById('frontCameraArea').classList.remove('hidden');
        const facingMode = document.getElementById('frontFacingSelect').value;
        if (frontStream) frontStream.getTracks().forEach(t => t.stop());
        frontStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode }, audio: false });
        document.getElementById('frontVideo').srcObject = frontStream;
        // إضافة overlay
        addOverlay('frontCameraArea');
      };
      document.getElementById('frontFacingSelect').onchange = async function() {
        if (frontStream) frontStream.getTracks().forEach(t => t.stop());
        const facingMode = this.value;
        frontStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode }, audio: false });
        document.getElementById('frontVideo').srcObject = frontStream;
      };
      document.getElementById('frontCloseCamera').onclick = function() {
        document.getElementById('frontCameraArea').classList.add('hidden');
        if (frontStream) { frontStream.getTracks().forEach(t => t.stop()); frontStream = null; }
        removeOverlay('frontCameraArea');
      };
      document.getElementById('frontCaptureBtn').onclick = function() {
        const video = document.getElementById('frontVideo');
        // قص الصورة داخل مربع الإرشاد
        const [cw, ch] = [video.videoWidth, video.videoHeight];
        const boxW = cw * 0.7, boxH = ch * 0.45;
        const sx = (cw - boxW) / 2, sy = (ch - boxH) / 2;
        const canvas = document.createElement('canvas');
        canvas.width = boxW;
        canvas.height = boxH;
        canvas.getContext('2d').drawImage(video, sx, sy, boxW, boxH, 0, 0, boxW, boxH);
        canvas.toBlob(blob => {
          const file = new File([blob], 'front.png', { type: 'image/png' });
          const dt = new DataTransfer();
          dt.items.add(file);
          document.getElementById('frontInput').files = dt.files;
          document.getElementById('frontPreview').src = URL.createObjectURL(blob);
          document.getElementById('frontPreview').classList.remove('hidden');
        }, 'image/png');
        document.getElementById('frontCameraArea').classList.add('hidden');
        if (frontStream) { frontStream.getTracks().forEach(t => t.stop()); frontStream = null; }
        removeOverlay('frontCameraArea');
      };
      document.getElementById('frontInput').onchange = function(e) {
        if (e.target.files[0]) {
          document.getElementById('frontPreview').src = URL.createObjectURL(e.target.files[0]);
          document.getElementById('frontPreview').classList.remove('hidden');
        }
      };

      // --- الكاميرا لخلف البطاقة ---
      let backStream = null;
      document.getElementById('backCameraBtn').onclick = async function() {
        document.getElementById('backCameraArea').classList.remove('hidden');
        const facingMode = document.getElementById('backFacingSelect').value;
        if (backStream) backStream.getTracks().forEach(t => t.stop());
        backStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode }, audio: false });
        document.getElementById('backVideo').srcObject = backStream;
        // إضافة overlay
        addOverlay('backCameraArea');
      };
      document.getElementById('backFacingSelect').onchange = async function() {
        if (backStream) backStream.getTracks().forEach(t => t.stop());
        const facingMode = this.value;
        backStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode }, audio: false });
        document.getElementById('backVideo').srcObject = backStream;
      };
      document.getElementById('backCloseCamera').onclick = function() {
        document.getElementById('backCameraArea').classList.add('hidden');
        if (backStream) { backStream.getTracks().forEach(t => t.stop()); backStream = null; }
        removeOverlay('backCameraArea');
      };
      document.getElementById('backCaptureBtn').onclick = function() {
        const video = document.getElementById('backVideo');
        // قص الصورة داخل مربع الإرشاد
        const [cw, ch] = [video.videoWidth, video.videoHeight];
        const boxW = cw * 0.7, boxH = ch * 0.45;
        const sx = (cw - boxW) / 2, sy = (ch - boxH) / 2;
        const canvas = document.createElement('canvas');
        canvas.width = boxW;
        canvas.height = boxH;
        canvas.getContext('2d').drawImage(video, sx, sy, boxW, boxH, 0, 0, boxW, boxH);
        canvas.toBlob(blob => {
          const file = new File([blob], 'back.png', { type: 'image/png' });
          const dt = new DataTransfer();
          dt.items.add(file);
          document.getElementById('backInput').files = dt.files;
          document.getElementById('backPreview').src = URL.createObjectURL(blob);
          document.getElementById('backPreview').classList.remove('hidden');
        }, 'image/png');
        document.getElementById('backCameraArea').classList.add('hidden');
        if (backStream) { backStream.getTracks().forEach(t => t.stop()); backStream = null; }
        removeOverlay('backCameraArea');
      };
      document.getElementById('backInput').onchange = function(e) {
        if (e.target.files[0]) {
          document.getElementById('backPreview').src = URL.createObjectURL(e.target.files[0]);
          document.getElementById('backPreview').classList.remove('hidden');
        }
      };

      document.getElementById('uploadBtn').addEventListener('click', async () => {
        const frontFile = document.getElementById('frontInput').files[0];
        const backFile = document.getElementById('backInput').files[0];
        if (!frontFile || !backFile) return alert('يرجى اختيار وجه وخلف البطاقة');
        try {
          // رفع الوجه
          const formDataFront = new FormData();
          formDataFront.append('nationalIdImage', frontFile);
          const resFront = await fetch(`${API_BASE}/api/nationalID/upload`, {
            method: 'POST',
            body: formDataFront
          });
          const dataFront = await resFront.json();
          if (!resFront.ok) throw new Error(dataFront.message || 'خطأ في رفع وجه البطاقة');
          // رفع الخلف
          const formDataBack = new FormData();
          formDataBack.append('nationalIdImage', backFile);
          const resBack = await fetch(`${API_BASE}/api/nationalID/upload`, {
            method: 'POST',
            body: formDataBack
          });
          const dataBack = await resBack.json();
          if (!resBack.ok) throw new Error(dataBack.message || 'خطأ في رفع خلف البطاقة');
          // نجاح
          window.location.href = 'arrive.html';
        } catch (err) {
          alert(err.message || 'حدث خطأ أثناء رفع الصور');
        }
      });

      // Overlay functions
      function addOverlay(areaId) {
        const area = document.getElementById(areaId);
        if (!area) return;
        let overlay = document.createElement('div');
        overlay.className = 'camera-overlay';
        overlay.style = `
          position: absolute;
          top: 50%; left: 50%;
          width: 70%; height: 45%;
          transform: translate(-50%, -50%);
          border: 2.5px dashed #2DAA9E;
          border-radius: 18px;
          pointer-events: none;
          z-index: 10;
        `;
        overlay.id = areaId + '-overlay';
        area.style.position = 'relative';
        area.appendChild(overlay);
      }
      function removeOverlay(areaId) {
        const overlay = document.getElementById(areaId + '-overlay');
        if (overlay) overlay.remove();
      }

    }

    // جلب آخر صورتين (وجه وخلف)
    fetch(`${API_BASE}/api/nationalID/all`)
      .then(res => res.json())
      .then(data => {
        let latestFront = '', latestBack = '';
        if (data.images && data.images.length > 0) {
          // نفترض أن الصور مرتبة: الوجه ثم الخلف (أو العكس حسب النظام)
          if (data.images.length >= 2) {
            latestFront = `${API_BASE}/nationalID/${data.images[data.images.length - 2]}`;
            latestBack = `${API_BASE}/nationalID/${data.images[data.images.length - 1]}`;
          } else {
            latestFront = `${API_BASE}/nationalID/${data.images[0]}`;
          }
        }
        showUploadForm(latestFront, latestBack);
      })
      .catch(err => {
        console.error(err);
        section.innerHTML = `<p class="text-red-600">تعذر جلب بيانات الصور. حاول إعادة التحميل.</p>`;
      });
  });
  </script>

</body>
</html>
