<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ملخص الجمعية - چمعية</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="dist/tailwind.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        .bg-saudi-green { background-color: #006C35; }
        .text-saudi-green { color: #006C35; }
        .border-saudi-green { border-color: #006C35; }
        .hover\:bg-saudi-green-darker:hover { background-color: #005A2C; }

        .text-dark-gray { color: #4a5568; }
        .bg-custom-light-gray { background-color: #f7fafc; }
        .bg-custom-medium-gray { background-color: #e2e8f0; }
        .text-custom-darker-gray { color: #2d3748; }
        .border-custom-light-gray { border-color: #edf2f7; }
        .bg-blue-600-custom { background-color: #2b6cb0; }
        .hover\:bg-blue-700-custom:hover { background-color: #2c5282; }

        .bg-custom-teal { background-color: #20b2aa; }
        .border-custom-teal { border-color: #20b2aa; }
        .text-custom-light-blue { color: #20b2aa; }

        .header-circular-dots-container { display: flex; justify-content: center; gap: 8px; padding: 5px 0 10px; width: 100%; }
        .header-circular-dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid; }
        .header-circular-dot.empty { background-color: transparent; border-color: #20b2aa; }
        .header-circular-dot.filled { background-color: #20b2aa; border-color: #20b2aa; }

        .timeline-flex-container { display: flex; justify-content: space-between; align-items: flex-start; padding: 0 10px; position: relative; margin-top: 10px; }
        .timeline-item-new { display: flex; flex-direction: column; align-items: center; text-align: center; flex: 1; position: relative; padding-bottom: 20px; }
        .timeline-item-new .month-label { font-size: 0.875rem; color: #718096; margin-top: 15px; }
        .timeline-dot-new { width: 8px; height: 8px; background-color: #cbd5e0; border-radius: 50%; position: absolute; top: 0px; left: 50%; transform: translateX(-50%); z-index: 1; }
        .timeline-line-horizontal { position: absolute; height: 2px; background-color: #cbd5e0; left: 10px; right: 10px; top: 4px; transform: translateY(-50%); z-index: 0; }

        .progress-segments-container { display: flex; gap: 4px; width: 100%; height: 8px; background-color: transparent; border-radius: 4px; overflow: hidden; margin-bottom: 10px; }
        .progress-segment { flex: 1; background-color: #d1d5db; border-radius: 2px; }
        .progress-segment.active { background-color: #006C35; }

        .bottom-nav { background-color: #006C35; position: fixed; bottom: 0; left: 0; right: 0; height: 60px; display: flex; justify-content: space-around; align-items: center; padding-bottom: env(safe-area-inset-bottom); z-index: 10; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2); }
        .bottom-nav-item { display: flex; flex-direction: column; align-items: center; color: #fff; font-size: 0.75rem; font-weight: 500; opacity: 0.7; transition: opacity 0.3s ease; }
        .bottom-nav-item.active { opacity: 1; color: #d1fae5; }
        .bottom-nav-item i { font-size: 1.25rem; margin-bottom: 2px; }
        .bottom-nav-center-btn { background-color: #006C35; width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: #fff; transform: translateY(-20%); box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.3); border: 4px solid #fff; transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease; }
        .bottom-nav-center-btn i { font-size: 1.5rem; }

        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; margin-right: 10px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: #2b6cb0; }
        input:focus + .toggle-slider { box-shadow: 0 0 1px #2196F3; }
        input:checked + .toggle-slider:before { transform: translateX(22px); }

        .timeline-item-new .month-label.active-month-label { color: #006C35 !important; font-weight: bold; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-right">

    <div class="max-w-md mx-auto bg-white shadow-lg rounded-lg overflow-hidden my-0 min-h-screen pb-20">
        <header class="flex items-center justify-between p-4 border-b border-gray-200 flex-col">
            <div class="flex items-center justify-between w-full mb-2">
                <a href="#" id="back-btn" class="text-gray-600 hover:text-gray-800">
                    <i class="fas fa-arrow-right text-xl"></i>
                </a>
                <h1 class="text-xl font-bold text-gray-800 flex-grow text-center">مُلخص عن الجمعية</h1>
                <div class="w-6"></div>
            </div>

            <div class="header-circular-dots-container">
                <div class="header-circular-dot filled"></div>
                <div class="header-circular-dot filled"></div>
                <div class="header-circular-dot filled"></div>
            </div>
        </header>

        <main class="p-4">

            <section class="bg-custom-light-gray rounded-lg p-4 mb-4 flex items-center justify-center">
                <div class="flex items-center text-sm font-medium text-gray-700">
                    <i class="fas fa-users text-gray-500 text-lg ml-2"></i>
                    <span>يوجد حالياً <span class="text-saudi-green font-bold">45 مستخدماً</span> مهتماً يحجزون هذا الدور.</span>
                </div>
            </section>

            <section class="flex bg-custom-medium-gray rounded-full p-1 mb-6">
                <button class="flex-1 py-2 px-4 rounded-full text-center text-custom-darker-gray font-medium bg-white shadow-sm">تفاصيل الجمعية</button>
                <button class="flex-1 py-2 px-4 rounded-full text-center text-gray-500 font-medium">تفاصيل المدفوعات</button>
            </section>

            <section class="mb-6">
                <h2 class="text-lg font-bold text-custom-darker-gray mb-4">تفاصيل الجمعية</h2>

                <div class="bg-white rounded-lg p-4 shadow-sm relative overflow-hidden mb-4 flex flex-col items-center">
                    <div class="flex items-center text-lg font-bold text-saudi-green mb-4">
                        <span id="turn-name" class="ml-2"></span>
                        <i class="fas fa-user-circle text-2xl"></i>
                    </div>

                    <div class="progress-segments-container mb-4 px-4">
                        <div class="progress-segment"></div>
                        <div class="progress-segment"></div>
                        <div class="progress-segment"></div>
                        <div class="progress-segment active"></div>
                        <div class="progress-segment"></div>
                        <div class="progress-segment"></div>
                    </div>

                    <div class="timeline-flex-container w-full">
                        <div class="timeline-line-horizontal"></div>

                        <div class="timeline-item-new">
                            <div class="timeline-dot-new"></div>
                            <span id="scheduled-date-label" class="month-label">يوليو 2025</span>
                        </div>

                        <div class="timeline-item-new">
                            <div class="timeline-dot-new"></div>
                            <span class="month-label">6 شهور</span>
                        </div>

                        <div class="timeline-item-new">
                            <div class="timeline-dot-new"></div>
                            <span class="month-label">ديسمبر 2025</span>
                        </div>
                    </div>

                    <p class="text-sm text-gray-600 mt-2 text-center">يتم إرسال القبض من يوم 15 إلى 30 في شهر القبض</p>
                </div>

                <div class="bg-white rounded-lg p-4 shadow-sm flex items-center mb-4">
                    <span class="text-xl font-bold text-saudi-green ml-2">%</span>
                    <input type="text" placeholder="أدخل كود الخصم" class="flex-1 border-none outline-none focus:ring-0 text-gray-700 placeholder-gray-400 text-sm py-2">
                    <button class="text-saudi-green text-sm font-medium opacity-50 cursor-not-allowed">تطبيق</button>
                </div>
            </section>

            <section class="mb-6">
                <h2 class="text-lg font-bold text-custom-darker-gray mb-4">حسابات القبض</h2>

                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-700 text-sm">مبلغ الجمعية</span>
                        <span id="assoc-amount" class="text-gray-900 font-bold"></span>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-700 text-sm">قسط شهر الاستلام</span>
                        <span id="installment" class="text-red-500 font-bold"></span>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-700 text-sm">رسوم الاشتراك</span>
                        <span id="admin-fees" class="text-red-500 font-bold"></span>
                    </div>
                    <div class="border-t border-gray-200 my-3"></div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-700 text-lg font-bold">إجمالي القبض</span>
                        <span id="total-receive" class="text-saudi-green text-xl font-bold"></span>
                    </div>
                </div>
            </section>

            <section class="mb-6">
                <h2 class="text-lg font-bold text-custom-darker-gray mb-4">الرسوم</h2>

                <div class="bg-white rounded-lg p-4 shadow-sm mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-700 text-sm">إجمالي رسوم الجمعية</span>
                        <span id="total-fees" class="text-gray-900 font-bold"></span>
                    </div>
                    <p class="text-xs text-gray-500 mb-4">تُقسّم رسوم الجمعية على أشهر محددة حتى شهر القبض.</p>

                    <!-- Delivery fee row with IDs for quick removal -->
                    <div class="flex justify-between items-center" id="delivery-row">
                        <span class="text-custom-light-blue text-sm font-bold">
                            رسوم توصيل العقد <i class="fas fa-question-circle text-gray-400 text-xs mr-1"></i>
                        </span>
                        <span id="delivery-fee" class="text-gray-900 font-bold"></span>
                    </div>
                    <p id="delivery-note" class="text-xs text-gray-500">يتم دفعها مرة واحدة فقط نقدًا عند التسليم</p>
                </div>
            </section>

        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const bottomNavItems = document.querySelectorAll('.bottom-nav-item');
            bottomNavItems.forEach(item => {
                item.addEventListener('click', function() {
                    bottomNavItems.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            const assocId = localStorage.getItem('selectedAssociationId');
            const token = localStorage.getItem('token');

            const fetchWithAuth = (url) => {
                return fetch(url, {
                    headers: {
                        ...(token ? { 'Authorization': `Bearer ${token}` } : {}),
                        'Accept': 'application/json'
                    }
                });
            };

            function fetchPublicTurnData() {
                const token = localStorage.getItem('token');
                const assocId = localStorage.getItem('selectedAssociationId') || '1';
                fetch(`https://api.technologytanda.com/api/turns/public/${assocId}`, {
                    headers: {
                        'Accept': 'application/json',
                        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    }
                })
                .then(res => {
                    if (res.status === 401) {
                        alert('يجب تسجيل الدخول للوصول إلى بيانات الجمعية.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = '/login.html';
                        return Promise.reject();
                    }
                    if (!res.ok) throw new Error('فشل في جلب بيانات الجمعية');
                    return res.json();
                })
                .then(data => {
                    if (data && data.turns && data.currentTurn) {
                        const currentTurn = data.currentTurn;
                        const turns = data.turns;
                        const assoc = turns[0]?.association || {};

                        const turnNameEl = document.getElementById('turn-name');
                        function extractTurnNumber(turnName) {
                            const match = turnName && turnName.match(/\d+$/);
                            return match ? parseInt(match[0], 10) : null;
                        }
                        let userTurn = turns.find(t => extractTurnNumber(t.turnName) === currentTurn.currentTurnMember?.turnNumber) || turns[0];
                        if (turnNameEl) { turnNameEl.textContent = userTurn?.turnName || ''; }

                        const scheduledDateEl = document.getElementById('scheduled-date-label');
                        if (scheduledDateEl) {
                            if (userTurn?.scheduledDate) {
                                const date = new Date(userTurn.scheduledDate);
                                const months = ["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"];
                                const monthName = months[date.getMonth()];
                                const year = date.getFullYear();
                                scheduledDateEl.textContent = `${monthName} ${year}`;
                            }
                        }

                        const progressContainer = document.querySelector('.progress-segments-container');
                        if (progressContainer) {
                            progressContainer.innerHTML = '';
                            turns.forEach((turn) => {
                                const div = document.createElement('div');
                                div.className = 'progress-segment' + (extractTurnNumber(turn.turnName) === currentTurn.currentTurnMember?.turnNumber ? ' active' : '');
                                progressContainer.appendChild(div);
                            });
                        }

                        const timelineContainer = document.querySelector('.timeline-flex-container');
                        if (timelineContainer) {
                            Array.from(timelineContainer.querySelectorAll('.timeline-item-new')).forEach(e => e.remove());
                            turns.forEach((turn) => {
                                const item = document.createElement('div');
                                item.className = 'timeline-item-new';
                                const isActive = extractTurnNumber(turn.turnName) === currentTurn.currentTurnMember?.turnNumber;
                                if (isActive) item.style.fontWeight = 'bold';
                                const dot = document.createElement('div');
                                dot.className = 'timeline-dot-new';
                                item.appendChild(dot);
                                const date = new Date(turn.scheduledDate);
                                const months = ["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"];
                                const monthName = months[date.getMonth()];
                                const year = date.getFullYear();
                                const label = document.createElement('span');
                                label.className = 'month-label' + (isActive ? ' active-month-label' : '');
                                label.textContent = `${monthName} ${year}`;
                                item.appendChild(label);
                                timelineContainer.appendChild(item);
                            });
                        }

                        document.getElementById('assoc-amount').innerHTML = currentTurn.totalPayout.toLocaleString() + ' <img src="./Assets/imgs/riyal.svg" alt="Saudi Arabia Flag" class="inline" />';
                        document.getElementById('installment').innerHTML = (assoc.monthlyAmount || 0).toLocaleString() + ' - <img src="./Assets/imgs/riyal.svg" alt="Saudi Arabia Flag" class="inline" />';
                        document.getElementById('admin-fees').innerHTML = (currentTurn.feeAmount || 0).toLocaleString() + ' - <img src="./Assets/imgs/riyal.svg" alt="Saudi Arabia Flag" class="inline" />';
                        document.getElementById('total-receive').innerHTML = (currentTurn.finalAmount || 0).toLocaleString() + ' <img src="./Assets/imgs/riyal.svg" alt="Saudi Arabia Flag" class="inline" />';
                        document.getElementById('total-fees').innerHTML = (currentTurn.feeAmount || 0).toLocaleString() + ' <img src="./Assets/imgs/riyal.svg" alt="Saudi Arabia Flag" class="inline" />';

                        /* QUICK FIX: hide delivery fee UI when zero/missing, else show value */
                        const deliveryRow   = document.getElementById('delivery-row');
                        const deliveryNote  = document.getElementById('delivery-note');
                        const deliveryFeeEl = document.getElementById('delivery-fee');
                        const fee = Number(currentTurn.contractDeliveryFee || 0);

                        if (!fee) {
                            deliveryRow?.remove();
                            deliveryNote?.remove();
                        } else if (deliveryFeeEl) {
                            deliveryFeeEl.innerHTML = fee.toLocaleString() + ' <img src="./Assets/imgs/riyal.svg" alt="Saudi Arabia Flag" class="inline" />';
                        }

                        const header = document.querySelector('h1');
                        if (header && assoc.name) header.textContent = assoc.name;
                    }
                })
                .catch(() => {
                    alert('حدث خطأ أثناء جلب بيانات الجمعية.');
                });
            }

            fetchPublicTurnData();

            const confirmBtn = document.querySelector('button.w-full.bg-blue-600-custom');
            const confirmModal = document.getElementById('confirm-modal');
            const closeConfirmModal = document.getElementById('close-confirm-modal');

            if (confirmBtn && confirmModal) {
              confirmBtn.addEventListener('click', () => confirmModal.classList.remove('hidden'));
            }
            if (closeConfirmModal && confirmModal) {
              closeConfirmModal.addEventListener('click', () => confirmModal.classList.add('hidden'));
            }
            if (confirmModal) {
              confirmModal.addEventListener('click', (e) => {
                if (e.target === confirmModal) confirmModal.classList.add('hidden');
              });
            }

            const backBtn = document.getElementById('back-btn');
            if (backBtn) {
              backBtn.addEventListener('click', function(e) {
                e.preventDefault();
                window.history.back();
              });
            }
        });
    </script>
</body>
</html>
