<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>الإشعارات</title>
  <!-- Tailwind CSS CDN for easy setup -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- You can configure Tailwind if needed, e.g., for custom colors -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#16a34a', // A green shade for primary elements
          }
        }
      }
    }
  </script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-primary/10 to-gray-100 min-h-screen flex items-center justify-center p-4 font-sans">

  <!-- Header -->
  <div class="fixed top-0 left-0 w-full bg-white shadow-lg z-10 py-4 px-6 flex items-center justify-between" dir="ltr">
    <div class="flex items-center gap-3">
      <span class="bg-primary text-white rounded-full p-2 shadow-md">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V4a2 2 0 10-4 0v1.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
        </svg>
      </span>
      <h1 class="text-xl md:text-2xl font-bold text-gray-800">الإشعارات</h1>
    </div>
    <div class="flex items-center gap-3 flex-wrap">
      <!-- Back Button - remains in header -->
      <button onclick="window.history.back()" class="flex items-center gap-1 px-3 py-1 rounded-full bg-primary/10 hover:bg-primary/20 text-primary border border-primary/30 transition text-sm font-semibold shadow-md">
        <i class="fas fa-arrow-right text-xs"></i> <!-- Arabic direction back arrow -->
        رجوع
      </button>
    </div>
  </div>

  <!-- New button area for "Mark All as Read" -->
  <div class="fixed top-[64px] left-0 w-full bg-gray-50 py-3 flex justify-center z-10 shadow-sm border-b border-gray-200">
    <button id="markAllReadBtn" class="flex items-center gap-1 px-4 py-2 rounded-full bg-primary text-white hover:bg-primary/90 transition text-sm font-semibold shadow-md">
      <i class="fas fa-check-double text-xs"></i>
      قراءة الكل
    </button>
  </div>

  <div class="w-full max-w-2xl bg-white shadow-2xl rounded-2xl p-0 mt-32 overflow-hidden">
    <!-- Status Message Display -->
    <div id="statusMessage" class="text-center py-2 text-sm font-medium transition-all duration-300 ease-in-out opacity-0 h-0 overflow-hidden"></div>

    <div class="divide-y divide-gray-200">
      <!-- Notifications List -->
      <div id="notificationsContainer" class="space-y-0">
        <!-- الإشعارات سيتم إضافتها هنا ديناميكيًا -->
        <div class="text-center py-10 text-gray-500">جاري تحميل الإشعارات...</div>
      </div>
      <!-- Pagination -->
      <div id="pagination" class="flex justify-between items-center px-6 py-4 bg-primary/5 text-sm text-gray-500 rounded-b-2xl">
        <button id="prevBtn" class="px-4 py-2 bg-white border border-primary hover:bg-primary/10 hover:text-primary rounded-full transition disabled:opacity-50 disabled:cursor-not-allowed shadow-sm">
          <svg class="inline w-4 h-4 ml-1 transform rotate-180" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
          السابق
        </button>
        <span id="pageInfo" class="font-semibold text-gray-700">صفحة 1</span>
        <button id="nextBtn" class="px-4 py-2 bg-white border border-primary hover:bg-primary/10 hover:text-primary rounded-full transition disabled:opacity-50 disabled:cursor-not-allowed shadow-sm">
          التالي
          <svg class="inline w-4 h-4 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Custom Confirmation Modal -->
  <div id="confirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 text-center">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">تأكيد الحذف</h3>
      <p class="text-gray-600 mb-6">هل أنت متأكد أنك تريد حذف هذا الإشعار؟</p>
      <div class="flex justify-center gap-4">
        <button id="cancelDeleteBtn" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-full hover:bg-gray-300 transition">إلغاء</button>
        <button id="confirmDeleteBtn" class="px-5 py-2 bg-red-600 text-white rounded-full hover:bg-red-700 transition">حذف</button>
      </div>
    </div>
  </div>

  <!-- Notification Toggle Button (if used elsewhere) -->
  <button id="notification-toggle" class="focus:outline-none hidden" title="الإشعارات / Notifications">
    <i class="bi bi-bell-fill text-2xl text-black hover:text-[#16a34a] transition-colors duration-200"></i>
  </button>

  <script>
    const container = document.getElementById("notificationsContainer");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const pageInfo = document.getElementById("pageInfo");
    const markAllReadBtn = document.getElementById("markAllReadBtn");
    const statusMessageDiv = document.getElementById("statusMessage");
    const confirmationModal = document.getElementById("confirmationModal");
    const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
    const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");

    let currentPage = 1;
    const limit = 10;
    let notificationToDeleteId = null; // To store the ID of the notification to be deleted

    // Always get the raw token (no Bearer prefix)
    let token = localStorage.getItem("token");
    if (token && token.startsWith("Bearer ")) {
      token = token.replace(/^Bearer\s+/, "");
      localStorage.setItem("token", token); // Fix it for future use
    }

    const notificationIcons = {
      default: `<svg class="w-8 h-8 text-primary" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M12 20a8 8 0 100-16 8 8 0 000 16z"/></svg>`,
      // You can add other types later, e.g., 'order': '<i class="fas fa-shopping-cart text-primary"></i>'
    };

    function getNotificationIcon(type) {
      // Can be expanded later based on notification type
      return notificationIcons[type] || notificationIcons.default;
    }

    /**
     * Displays a temporary status message to the user.
     * @param {string} message - The message to display.
     * @param {boolean} isError - True if it's an error message, false otherwise.
     */
    function displayStatusMessage(message, isError = false) {
      statusMessageDiv.textContent = message;
      statusMessageDiv.className = `text-center py-2 text-sm font-medium transition-all duration-300 ease-in-out opacity-100 h-auto overflow-hidden ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;

      setTimeout(() => {
        statusMessageDiv.className = `text-center py-2 text-sm font-medium transition-all duration-300 ease-in-out opacity-0 h-0 overflow-hidden`;
      }, 3000); // Message disappears after 3 seconds
    }

    /**
     * Marks a single notification as read.
     * @param {number} notificationId - The ID of the notification to mark as read.
     * @param {HTMLElement} notificationElement - The DOM element of the notification card.
     */
    async function markNotificationAsRead(notificationId, notificationElement) {
      try {
        if (!token) {
          displayStatusMessage("🛑 يجب تسجيل الدخول أولاً", true);
          return;
        }

        // Optimistically update UI
        notificationElement.classList.remove('bg-primary/10');
        notificationElement.classList.add('bg-white');
        const unreadDot = notificationElement.querySelector('.unread-dot');
        if (unreadDot) {
          unreadDot.remove();
        }
        notificationElement.dataset.isRead = 'true'; // Update data attribute

        const res = await fetch(`https://api.technologytanda.com/api/userData/notifications/${notificationId}/read`, {
          method: 'PUT',
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
        });

        if (!res.ok) {
          // Revert UI on error
          notificationElement.classList.remove('bg-white');
          notificationElement.classList.add('bg-primary/10');
          // Re-add unread dot if needed (more complex, might require re-rendering or storing original state)
          // For simplicity, re-fetching all notifications on error is a robust fallback.
          fetchNotifications(currentPage); // Re-fetch to ensure consistency
          throw new Error(`⚠️ فشل في تحديث الإشعار. رمز الحالة: ${res.status}`);
        }

        const data = await res.json();
        displayStatusMessage(data.message || "تم وضع علامة على الإشعار كمقروء");

      } catch (error) {
        displayStatusMessage(error.message, true);
        console.error("Error marking notification as read:", error);
        fetchNotifications(currentPage); // Re-fetch to ensure UI consistency after error
      }
    }

    /**
     * Marks all notifications as read.
     */
    async function markAllNotificationsAsRead() {
      try {
        if (!token) {
          displayStatusMessage("🛑 يجب تسجيل الدخول أولاً", true);
          return;
        }

        displayStatusMessage("جاري وضع علامة على جميع الإشعارات كمقروءة...");
        markAllReadBtn.disabled = true; // Disable button during request

        const res = await fetch(`https://api.technologytanda.com/api/userData/notifications/read-all`, {
          method: 'PUT',
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
        });

        if (!res.ok) {
          throw new Error(`⚠️ فشل في وضع علامة على جميع الإشعارات كمقروءة. رمز الحالة: ${res.status}`);
        }

        const data = await res.json();
        displayStatusMessage(data.message || "تم وضع علامة على جميع الإشعارات كمقروءة بنجاح!");
        await fetchNotifications(currentPage); // Re-fetch to update UI
      } catch (error) {
        displayStatusMessage(error.message, true);
        console.error("Error marking all notifications as read:", error);
      } finally {
        markAllReadBtn.disabled = false; // Re-enable button
      }
    }

    /**
     * Deletes a single notification.
     * @param {number} notificationId - The ID of the notification to delete.
     */
    async function deleteNotification(notificationId) {
      try {
        if (!token) {
          displayStatusMessage("🛑 يجب تسجيل الدخول أولاً", true);
          return;
        }

        displayStatusMessage("جاري حذف الإشعار...");

        const res = await fetch(`https://api.technologytanda.com/api/userData/notifications/${notificationId}`, {
          method: 'DELETE',
          headers: {
            "Authorization": `Bearer ${token}`,
          },
        });

        if (!res.ok) {
          throw new Error(`⚠️ فشل في حذف الإشعار. رمز الحالة: ${res.status}`);
        }

        const data = await res.json();
        displayStatusMessage(data.message || "تم حذف الإشعار بنجاح!");
        await fetchNotifications(currentPage); // Re-fetch to update UI
      } catch (error) {
        displayStatusMessage(error.message, true);
        console.error("Error deleting notification:", error);
      } finally {
        hideConfirmationModal(); // Always hide the modal
      }
    }

    /**
     * Shows the confirmation modal.
     * @param {number} id - The ID of the notification to be deleted.
     */
    function showConfirmationModal(id) {
      notificationToDeleteId = id;
      confirmationModal.classList.remove('hidden');
    }

    /**
     * Hides the confirmation modal.
     */
    function hideConfirmationModal() {
      notificationToDeleteId = null;
      confirmationModal.classList.add('hidden');
    }

    /**
     * Fetches and displays notifications for the given page.
     * @param {number} page - The page number to fetch.
     */
    async function fetchNotifications(page = 1) {
      container.innerHTML = `<div class="text-center py-10 text-gray-500">جاري تحميل الإشعارات...</div>`; // Show loading state
      try {
        if (!token) {
          container.innerHTML = `<div class="text-red-600 text-center py-10">🛑 يجب تسجيل الدخول أولاً</div>`;
          return;
        }

        const res = await fetch(`https://api.technologytanda.com/api/userData/notifications?page=${page}&limit=${limit}`, {
          headers: {
            "Authorization": `Bearer ${token}`,
          },
        });

        if (!res.ok) {
          if (res.status === 401) {
            container.innerHTML = `<div class="text-red-600 text-center py-10">⛔ غير مصرح. يرجى تسجيل الدخول مجددًا</div>`;
          } else {
            container.innerHTML = `<div class="text-red-600 text-center py-10">⚠️ حدث خطأ في تحميل البيانات. رمز الحالة: ${res.status}</div>`;
          }
          return;
        }

        const data = await res.json();
        if (!data.notifications) {
          throw new Error("❌ لم يتم العثور على بيانات إشعارات");
        }

        container.innerHTML = ""; // Clear previous notifications

        if (data.notifications.length === 0) {
          container.innerHTML = `<div class="text-gray-600 text-center py-10">لا توجد إشعارات حالياً</div>`;
        } else {
          data.notifications.forEach(notif => {
            const date = new Date(notif.createdAt).toLocaleString('ar-EG', {
              dateStyle: 'short',
              timeStyle: 'short'
            });

            const notifTitle = notif.title && notif.title.trim() !== "" ? notif.title : "إشعار جديد";

            const card = document.createElement("div");
            // Add data attributes for ID and read status
            card.dataset.id = notif.id;
            card.dataset.isRead = notif.isRead;
            card.className = `flex items-center justify-between gap-4 px-6 py-5 border-b border-gray-200 last:border-b-0 transition duration-300 cursor-pointer hover:bg-gray-50 ${notif.isRead ? 'bg-white' : 'bg-primary/10'}`;
            card.innerHTML = `
              <div class="flex items-center gap-4 flex-1 min-w-0">
                <div class="relative flex-shrink-0">
                  ${getNotificationIcon(notif.type)}
                  ${!notif.isRead ? `<span class="unread-dot absolute top-0 right-0 w-3 h-3 bg-primary rounded-full border-2 border-white animate-pulse"></span>` : ''}
                </div>
                <div class="flex-1 min-w-0">
                  <div class="flex flex-wrap items-center gap-2">
                    <span class="font-semibold text-gray-800 text-base">${notifTitle}</span>
                    <span class="text-xs text-gray-500">${date}</span>
                  </div>
                  <p class="text-gray-600 mt-1 text-sm">${notif.message}</p>
                </div>
              </div>
              <button class="delete-btn flex-shrink-0 text-red-500 hover:text-red-700 transition" data-id="${notif.id}">
                <i class="fas fa-trash-alt"></i>
              </button>
            `;
            // Add click listener to each notification card (for marking as read)
            card.addEventListener('click', (event) => {
              // Ensure the click is not on the delete button itself
              if (!event.target.closest('.delete-btn')) {
                const clickedId = event.currentTarget.dataset.id;
                const isRead = event.currentTarget.dataset.isRead === 'true';
                if (clickedId && !isRead) { // Only mark as read if not already read
                  markNotificationAsRead(parseInt(clickedId), event.currentTarget);
                }
              }
            });

            // Add click listener for the delete button
            const deleteButton = card.querySelector('.delete-btn');
            deleteButton.addEventListener('click', (event) => {
              event.stopPropagation(); // Prevent the card's click listener from firing
              const idToDelete = parseInt(event.currentTarget.dataset.id);
              showConfirmationModal(idToDelete);
            });

            container.appendChild(card);
          });
        }

        currentPage = data.pagination.page;
        pageInfo.textContent = `صفحة ${currentPage}`;
        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = !data.pagination.hasMore;

      } catch (error) {
        container.innerHTML = `<div class="text-red-600 text-center py-10">${error.message}</div>`;
        console.error(error);
      }
    }

    // Event Listeners
    prevBtn.addEventListener("click", () => {
      if (currentPage > 1) fetchNotifications(currentPage - 1);
    });

    nextBtn.addEventListener("click", () => {
      fetchNotifications(currentPage + 1);
    });

    markAllReadBtn.addEventListener("click", markAllNotificationsAsRead);

    // Confirmation modal button listeners
    confirmDeleteBtn.addEventListener('click', () => {
      if (notificationToDeleteId) {
        deleteNotification(notificationToDeleteId);
      }
    });

    cancelDeleteBtn.addEventListener('click', hideConfirmationModal);

    // Notification toggle button (if used elsewhere, currently hidden)
    document.getElementById('notification-toggle')?.addEventListener('click', () => {
      window.location.href = 'Notification.html';
    });

    // Initial fetch of notifications when the page loads
    fetchNotifications();
  </script>
</body>
</html>
